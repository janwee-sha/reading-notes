# 第一章、逃离单体地狱

## 一、单体地狱

- 复杂性；
- 开发速度缓慢；
- 从代码提交到实际部署的周期很长，而且易出问题；
- 难以拓展；
- 交付可靠的单体应用是一项挑战；
- 需要长期依赖某个可能过时的技术栈。

## 二、微服务架构

### 1. 三维拓展
- X轴拓展：在多个实例之间实现请求的负载均衡；
- Y轴拓展：根据功能把应用拆分为服务；
- Z轴拓展：根据请求的属性路由请求。

### 2.作为模块化的一种形式

微服务架构使用服务作为模块化的单元。

### 3.每个服务都拥有自己的数据库


# 第二章、服务的拆分策略

## 一、架构风格

### 1.分层式架构风格

分层架构将软件元素按“层”的方式组织。每个层都有明确定义的职责，且限制了层之间的依赖关系。

三层架构：
- 表现层：包含实现用户界面或外部API的代码。
- 业务逻辑层：包含业务逻辑。
- 数据持久化层：实现与数据库交互的逻辑。

分层架构的弊端：

- 单个表现层：它无法展现应用程序可能不仅仅由单个系统调用的事实。
- 单一数据持久化层：它无法展现应用程序可能与多个数据库进行交互的事实。
- 将业务逻辑层定义为依赖于数据持久化层：理论上，这样的依赖性会妨碍你在没有数据库的情况下测试业务逻辑。此架构的特性和优点是业务逻辑不依赖于适配器，相反，各种适配器都依赖逻辑。

### 2.六边形架构

六边形架构是分层架构风格的替代品。在六边形架构中，应用程序的核心是业务逻辑组件，在业务逻辑组件外围是各种用来实现用户界面和与外部服务集成的适配器。

六边形的优点：

- 将业务逻辑与适配器中包含的表示层和数据访问层的逻辑分离开来。业务逻辑不依赖于表示层或数据访问层逻辑。
- 更准确地反映了现代应用程序的架构。

### 3.微服务架构是一种架构风格

微服务架构的实现视图由多个组件构成：一组可执行文件或WAR文件。

- 服务：服务是单一的、可独立部署的软件组件。
- 松耦合：服务之间的松耦合性是微服务架构的最核心特性。

## 二、使用领域驱动设计拆分微服务

**通用语言**定义了当前领域相关团队的词汇表。
领域驱动为每个**子域**定义单独的领域模型。子域是领域的一部分，**领域**是DDD中用来描述应用程序问题域的一个术语。DDD把领域模型的边界称为**限界上下文**。限界上下文包含实现这个模型的代码集合。

DDD的子域和限界上下文的概念，可以很好地跟微服务架构中的服务进行匹配。而且，微服务架构中的自治化团队负责服务开发的概念，也跟DDD中每个领域模型都由一个独立团队负责开发的概念吻合。

### 1.拆分的指导原则

- **单一职责原则**：改变一个类应该只有一个理由。
    
- **闭包原则**：在包中包含的所有类应该是对同类的变化的一个集合，也就是说，如果对包做出修改，需要调整的类应该都在这个包之内。

### 2.拆分的障碍

- **网络延迟**：对服务的特定分解会导致两个服务之间的大量往返调用
- **同步进程间通信导致可用性降低**
- **在服务之间维持数据一致性**：操作需要更新多个服务的数据时，仍旧维护服务之间的数据一致性
- **获取一致的数据视图**：分解的另一个障碍是无法跨多个数据库获得真正一致的数据视图
- **上帝类阻碍了拆分**：上帝类是在整个应用程序中使用的全局类。上帝类通常为应用程序的许多不同方面实现业务逻辑。


# 第三章、微服务架构中的进程间通信

## 一、交互方式


-| 一对一 | 一对多
---|---|---
同步模式 | 请求/响应 | 无
异步模式 | 异步请求/响应、单向通知 | 发布/订阅、发布/异步响应

## 二、消息的格式

进程间通信的本质是交换消息。

### 1.基于文本的消息格式

JSON、XML等。可读性高，自描述的；另一方面，这类消息往往过度冗长，造成额外的开销。

### 2.二进制消息


# 第四章、使用Saga管理事务

## 一、微服务架构下的事务管理

### 1.微服务架构对分布式事务的需求

保障多数据库环境下的数据一致性。

### 2.分布式事务的挑战

分布式事务的事实标准是X/Open XA。XA采用**两阶段提交**来保证事务中所有参与方同时完成提交，或者在失败时同时回滚。

- 许多新技术并不支持分布式事务；

-本质上都是同步进程通信，这会降低分布式系统的可用性。

### 3.使用Saga模式维护数据一致性

Saga是一种在微服务架构中维护数据一致性的机制，它可以避免分布式事务带来的问题。一个Saga表示需要更新多个服务中数据的一个系统操作。

Saga使用补偿事务来回滚所作出的改变。

## 二、Saga的协调模式

- 协同式：把Saga的决策和执行顺序逻辑分布在Saga的每一个参与方中，它们通过交换事件的方式来进行沟通。
- 编排式：把Saga的决策和执行顺序逻辑集中在一个Saga编排器类中。编排器发出命令式消息给各个参与方，指示这些参与方服务完成具体操作。

### 1.协同式Saga

基于协同式的Saga的参与方使用发布/订阅进行交互。

**需要考虑的问题**：

可靠的事件通信。

确保Saga参与方将更新其本地数据库和发布事件作为数据库事务的一部分；确保Saga参与方必须能够将接收到的每个事件映射到自己的数据上。

**协同式Saga的好处**：

- 简单：服务在创建、更新或删除业务对象时发布事件
- 松耦合：参与方订阅事件并且彼此之间不会因此产生耦合。

**协同式Saga的弊端**：

- 更难理解：与编排式不同，代码中没有一个单一地方定义了Saga。
- 服务之间的循环依赖关系：Saga参与方订阅彼此的事件，这通常会导致循环依赖关系。
- 紧耦合的风险：每个Saga参与方都需要订阅所有影响它们的事件。

### 2.编排式Saga

**把Saga编排器视为一个状态机**

**Saga编排和事务性消息**

**编排式Saga的好处**

- 更简单的依赖关系：编排式不会引入循环依赖关系。Saga编排器调用Saga参与方，但参与方不会调用编排器。

- 较少的耦合：每个服务实现供编排器调用的API，因此它不需要知道Saga参与方发布的事件。

- 改善关注点隔离，简化业务逻辑：Saga的协调逻辑本地化在Saga编排器中。

**编排式Saga的弊端**

- 存在集中过多业务逻辑的风险。

## 三、解决隔离问题

使用Saga的挑战在于它们缺乏事务的隔离性，每个Saga的本地事务所做的更新都会立即被其他Saga看到。因此，Saga只满足ACD三个属性：

- **原子性**：Saga实现确保执行所有事务或撤销所有更改。
- **一致性**：服务内的参照完整性由本地数据库处理。服务之间的参照完整性由服务处理。
- **持久性**：由本地数据库处理。

### 1.缺乏隔离导致的问题

- **丢失更新**：一个Saga没有读取更新，而是直接付好了另一个Saga所做的更改。
- **脏读**：一个事务或一个Saga读取了尚未完成的Saga所做的更新。
- **模糊或不可重复读**：一个Saga的两个不同步骤读取相同的数据却得到不同的结果，因为另一个Saga已经进行了更新。

### 2.隔离对策



# 第五章、微服务架构中的业务逻辑设计

## 一.业务逻辑组织模式

- 事务脚本模式（面向过程）:实现行为的类与存储状态的类是分开的。
- 领域建模模式（面向对象）：实现行为的类与存储状态的类是在一起的。

## 二.关于领域驱动设计

DDD是对面向对象设计的改进，是开发复杂业务逻辑的一种方法。子域和相关联的限界上下文的相关概念是两种战略性DDD模式。

DDD还有一些战术性模式，它们是领域模型的基本元素：

- **实体**：具有持久化ID的对象。
- **值对象**：作为值集合的对象。
- **聚合**：一个边界内的领域对象的集群，可以将其视为一个单元。由根实体和可能的一个或多个其他实体和值对象组成。
- **工厂**：负责实现对象创建逻辑的对象或方法，该逻辑过于复杂，无法由类的构造函数直接完成。
- **存储库**：用来访问持久化实体的对象，存储库也封装了访问数据库的底层机制。
- **服务**：实现不属于实体或值对象的业务逻辑的对象。

## 三.使用聚合模式设计领域模型

将领域模型组织为聚合的集合，每个聚合都是可以作为一个单元进行处理的一组对象构成的图。

### （1）聚合拥有明确的边界

#### A.聚合代表了一致的边界

更新聚合而不是聚合的一部分可以解决一致性问题。

#### B.识别聚合是关键

在DDD中，设计领域模型的关键部分是识别聚合，以及它们的边界和根。

### （2）聚合的规则

#### A.规则一：只引用聚合根

聚合根是聚合中唯一可以由外部类引用的部分。此规则可以确保聚合能够强制执行各种不变量约束。

#### B.规则二：聚合间的引用必须使用主键

引用聚合必须通过标识而不是对象引用。此规则确保聚合之间的边界得到很好的定义，并避免意外更新不同的聚合。

#### C.规则三：一个事务只能创建或更新一个聚合

此规则可以确保单个事务的范围不超越服务的边界，此约束还满足大对数NoSQL数据库的受限事务模型。

在单个服务中维护多个聚合的一致性的另一种方法是打破聚合规则，在一个事务中更新多个聚合。

### （3）聚合的颗粒度

开发领域模型必须决定每个聚合的大小。细粒度聚合将提高应用程序能同时处理的请求数量，从而提高可拓展性，同时降低了两个用户同时更新一个聚合而引发冲突的可能性；粗粒度聚合更能使特定的聚合更新操作满足事务的原子性。

## 四.发布领域事件

在DDD中，领域事件是聚合发生的事件。聚合在被创建时，或发生其他重大改变时发布领域事件。

### (1).为什么需要发布变更事件

领域事件很有用，因为应用程序的其他协作方（比如客户方、其他应用程序或同一应用程序的其他组件）通常有兴趣了解聚合的状态更改。

# 第九章、微服务架构中的测试策略（上）

## 一、概述

### 1.自动化测试通常包括四个阶段

- 设置环境
- 执行测试
- 验证结果
- 清理环境

### 2.使用模拟和桩进行测试

**测试替身**：一个对象，负责模拟依赖项的行为。

有两种类型的测试替身：**桩**（Stub）和**模拟**（Mock）。

### 3.测试的不同类型

- **单元测试**：测试服务的一小部分，例如类。
- **集成测试**：验证服务是否可以与基础设施服务（如数据库）或其他应用程序服务进行交互。
- **组件测试**：单个服务的验收测试。
- **端到端测试**：整个应用程序的验收测试。



