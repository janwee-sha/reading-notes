# 1.RabbitMQ基础

## 1.3 松耦合架构的优势

消息中间件（Message-oriented middleware）是一种软件或硬件基础设施，通过它可以在分布式系统中发送和接收消息。

### 1.3.6 高级消息队列模型

RabbitMQ的很多强大功能和灵活性来自于AMQP规范。不像HTTP和SMTP协议，AMQP规范不仅定义了一种网络协议，同时也定义了服务器端的服务和行为。这些信息就是高级消息队列（Advanced Message Queue）模型。针对代理服务器软件，AMQ模型在逻辑上定义了三种抽象组件用于指定消息的路由行为：

- 交换器（Exchange），消息代理服务器中用于把消息路由到队列的组件。
- 队列（Queue），用于存储消息的数据结构，位于硬盘或内存中。
- 绑定（Binding），一套规则，用于告诉交换器消息应该被存储到哪个队列。

# 2.使用AMQ协议与Rabbit进行交互

## 2.2 AMQP RPC帧结构

AMQP使用类和方法在客户端和服务器之间创建公共语言，这些类和方法被称为AMQP命令。

### 2.2.1 AMQP帧组件

低层AMQP帧由五个不同的组件组成：

- 帧类型
- 信道编号
- 以字节为单位的帧大小
- 帧有效载荷
- 结束字节标记（ASCII值206）

### 2.2.2 帧类型

AMQP规范定义了五种类型的帧：

- 协议头帧，用于连接到RabbitMQ，仅使用一次。
- 方法帧，携带发送给RabbitMQ或从RabbitMQ接收到的RPC请求或响应。
- 内容头帧，包含一条消息的大小和属性。
- 消息体帧，包含消息的内容。
- 心跳帧，在客户端与RabbitMQ之间进行传递，作为一种校验机制确保连接的两端都可用且在正常工作。

协议头帧和心跳帧对于开发者而言通常是透明的，而在编写与RabbitMQ进行通信的应用程序时，方法帧、内容头帧、消息体帧以及它们的结构通常是可见的。

### 2.2.3 将消息编组成帧

AMQP的帧大小有一个上限，如果超过这个上限，消息内容会拆分成多个消息体帧。这些帧始终以方法帧、内容头帧及一个或多个消息体帧的顺序发送。

向RabbitMQ发送消息时，在方法帧中会发送一个Basic.Publish命令，随后是一个带有消息属性的内容头帧，这些属性被封装在AMQP规范中所定义的Basic.Properties数据结构中。

发布到RabbitMQ的单个消息由三种帧类型组成：


帧类型 | 信道 | 字节大小 | 帧有效载荷 |结束字节标记
---|---|---|---|---
1 | 1 | 41 | Basic.Publish | 0xce 
2 | 1 | 82 | Content Header | 0xce
3 | 1 | 56 | Body | 0xce

### 2.2.4 方法帧结构

方法帧携带构建RPC请求所需的类、方法及相关参数。

方法帧有效载荷：

Basic | Publish | 交换器名称 |路由键值 | Mandatory标志

### 2.3.1 声明交换器

交换器在AMQ模型中是一等公民。它们在AMQP规范中都有自己的类。

客户端——Exchange.Declare——>服务器

客户端<——Exchange.DeclareOk/Channel.Close——服务器

### 2.3.2 声明队列

客户端——Queue.Declare——>服务器

客户端<——Queue.DeclareOk——服务器

### 2.3.3 绑定队列到交换器

客户端——Queue.Bind——>服务器

客户端<——Queue.BindOk——服务器

### 2.3.4 发布消息到RabbitMQ

客户端——Basic.Publish——>服务器

客户端——内容头——>服务器

客户端——消息体——>服务器

### 2.3.5 从RabbitMQ消费消息

**请求消费：**

客户端——Basic.Consume——>服务器

客户端<——Basic.ConsumeOk——服务器

客户端<——Basic.Deliver——服务器

**取消消费：**

客户端——Basic.Cancel——>服务器

客户端<——Basic.CancelOk——服务器

# 3.消息属性详解

## 3.1 合理使用属性

基本属性：

- content-type，消息体数据类型。
- content-encoding，指示消息体使用的编码方式。
- message-id和correlation来唯一标识消息和消息响应，用于实现消息跟踪。
- timestamp，描述消息创建时间。
- expiration，消息过期时间。
- delivery-mode，描述消息写入磁盘或内存队列，1表示非持久化消息，2表示持久化消息。
- app-id和user-id，描述消息发布者应用程序。
- type，定义发布者和消费者之间的契约。
- headers，定义自由格式的属性和实现RabbitMQ路由。

属性 | 类型 | 用途 | 描述
---|---|---|---
app-id | short-string | 应用程序 | 定义发布消息的应用程序
content-encoding | short-string  | 应用程序 | 指定消息体使用的编码方式
content-type | 消息体数据类型

## 4.1 平衡投递速度与可靠机制

各可用性保障机制的投递速度按以下顺序递减：

- 没有保障
- 失败通知
- 发布者确认
- 备用交换器
- 高可用队列
- 事务
- 基于事务的高可用队列
- 消息持久化

