# 1 简介

## 1.1 ZooKeeper的使命

ZooKeeper可以在分布式系统中协作多个任务。一个协作任务是指一个包含多个进程的任务。这个任务可以是为了协作或者是为了管理竞争。协作意味着多个进程需要一同处理某些事情，一些进程采取某些行动使得其他进程可以继续工作。竞争指的是两个进程不能同时处理工作的情况，一个进程必须等待另一个进程。

Zookeeper的使用实例：

**Apache HBase**

HBase是一个通常与Hadoop一起使用的数据存储仓库。在HBase中，ZooKeeper用于选举一个集群内的主节点，以便跟踪可用的服务器，并保存集群的元数据。

**Apache Kafka**

一个基于发布-订阅模型的消息系统。ZooKeeper用于检测崩溃，实现主题的发现，并保持主题的生产和消费状态。

**Apache Solr**

一个企业级的搜索平台。使用ZooKeeper存储集群的元数据，并协作更新这些元数据。

**Facebook Messages**

将ZooKeeper作为控制器，实现数据分片、故障恢复和服务发现等功能。

ZooKeeper的客户端API功能强大，其中包括：

- 保障强一致性、有序性和持久性。
- 实现通用的同步原语的能力。
- 在实际分布式系统中，并发往往导致不正确的行为。ZooKeeper提供了一种简单的并发机制。

### 1.1.2 ZooKeeper不适用的场景

ZooKeeper不适合用作海量数据存储。

### 1.1.4 通过ZooKeeper构建分布式系统

使用一个独立的协调组件有几个重要的好处：

- 独立地设计和实现该组件，这样独立的组件可以跨多个应用共享。
- 系统架构师可以简化协作方面的工作，这些并不是琐碎的i下凹式。
- 系统可以独立地运行和协作这些组件，也简化了生产环境中解决实际问题的任务。

分布式系统的进程通信有两种选择：直接通过网络进行信息交换，或读写某些共享存储。ZooKeeper使用共享存储模型来实现应用间的协作和同步原语。对于共享存储本身，又要在进程和存储间进行网络通信。

在真实的系统中，我们需要特别注意以下问题：

- 消息延迟——消息传输可能会发生任意延迟。
- 处理器性能——操作系统的调度和超载也可能导致消息处理的任意延迟。
- 时钟偏移——处理器时钟并不可靠，它们之间也会发生任意的偏移。依赖处理器始终也许会导致错误的决策。

## 1.2 示例：主-从应用

在主-从架构中，主节点进程赋值跟踪从节点状态和任务的有效性，并分配任务到从节点。

要实现主-从模式，我们必须解决以下三个关键问题：

- 主节点崩溃
  
  如果主节点发送错误并使小，系统将无法分配新的任务或重新分配已失败的任务。

- 从节点崩溃

  如果从节点崩溃，已分配的任务将无法完成。

- 通信故障

  如果主节点和从节点之间无法进行信息交换，从节点将无法得知新任务分配给它。
 
### 1.2.1 主节点失效

主节点失效时，我们需要有一个备份主节点（backup master）。当主要主节点（primary master）崩溃时，备份从节点接管主要主节点的角色，进行故障转移。新的主要主节点需要能够恢复到旧的主要主节点崩溃时的状态。对于主节点状态的可恢复性，我们不能依靠从已经崩溃的主节点来获取这些信息，而需要从其他地方获取，也就是通过ZooKeeper来获取。

状态恢复并不是唯一的重要问题。例如主机点有效，备份主节点却认为主节点已经崩溃。从而接管主节点的角色，成为第二个从节点。更糟的是从系欸但因为无法与主要主节点通信，而与第二个主节点建立主-从关系。这种场景一般称为脑裂。

### 1.2.2 从节点失效

如果从节点崩溃了，所有已派发给这个从节点且尚未完成的任务需要重新派发。其中首要需求是让主节点具有检测从节点崩溃的能力。从节点崩溃时也许执行了部分任务，也许全部执行完但没有报告结果。如果整个运算过程产生其他作用，我们还有必要执行某些恢复过程来清除之前的状态。

### 1.2.3 通信故障

如果一个从节点与主节点的网络连接断开，比如网络分区（network partition）导致，重新分配一个任务可能会导致两个从节点执行相同的任务。如果任务允许多次执行，我们不用验证第一个从几点是否完成了该任务；否则应用需要适应多个从节点执行相同任务的可能性。

