# 第5章 创建高性能的索引

## 5.1 索引基础

在MySQL中，存储引擎先在索引中找到对应值，然后根据匹配的索引记录找到对应的数据行。

### 5.1.1 索引的类型

在MySQL中，索引是在存储引擎层而不是服务器层实现的。所以并没有统一的索引标准：不同的存储引擎的索引工作方式并不一样，也不是所有引擎都支持所有类型的索引。

#### B-Tree索引

MySQL在CREATE TABLE和其他语句中使用的是"BTREE"关键字，但存储引擎也可能使用不同的存储结构，如，NDB集群存储引擎内部实际上使用了T-Tree结构存储这种索引；InnoDB则使用的是B+Tree。

B-Tree索引适用于全键值、键值范围或键前缀查找。

B-Tree索引支持以下查找类型：
- 全值匹配
- 匹配最左前缀
- 匹配最左列前缀
- 匹配范围值
- 精确匹配某一列并范围匹配另外一列
- 只访问索引的查询

B-Tree索引的限制：
- 如非按照索引的最左列开始查找，则无法使用索引。
- 不能跳过索引中的列。
- 如果查询中有某个列的范围查询，则其右边所有列都无法使用索引优化查找。

#### 哈希索引

哈希索引（hash index）基于哈希表实现，只有精确匹配索引所有列的查询才有效。对于每一行数据，存储引擎都会对所有的索引列计算一个哈希码，不同键值的行计算出来的哈希码不一样。哈希索引将所有的哈希码存储在索引中，同时在哈希表中保存指向每个数据行的指针。

哈希索引的限制：
- 哈希索引只包含哈希值和行指针，而不存储字段值，所以不能使用索引中的值来避免读取行。
- 哈希索引数据并不是按照索引值顺序存储的，无法用于排序。
- 哈希索引不支持部分索引列匹配查找，因为哈希索引始终使用所有索引列的全部内容来计算索引值。
- 哈希索引只支持等值比较查询，包括=、IN()、<=>，不支持范围查询。
- 哈希冲突很多时，一些索引维护操作的代价会很高。

因为上述限制，哈希索引只适用于某些特定的场合。而一旦适合哈希索引，则它带来的性能提升将会非常显著，如“星型”schema。

InnoDB引擎有一个特殊的功能叫“自适应哈希索引”（adaptive hash index）。当InnoDB注意到某些索引值被使用得非常频繁时，它会在内存中基于B-Tree索引之上再创建一个哈希索引。

#### 空间数据索引（R-Tree）

MyISAM表支持空间索引，可以用作地理数据存储。和B-Tree索引不同，这类索引无须前缀查询。空间索引会从所有维度来索引数据，可以有效地使用任意维度来组合查询。MySQL的GIS支持并不完善。

#### 全文索引

全文索引是一种特殊类型的索引，它查找的是文本中的关键词，而不是直接比较索引中的值。

#### 其他索引类别

TokuDB的分形树索引是较新开发的数据结构，既有B-Tree的很多优点，也避免了B-Tree的一些缺点。

ScaleDB的Patricia tries。

## 5.2 索引的优点

索引可以让服务器快速地定位到表的指定位置。但是这并不是索引的唯一作用，根据创建索引的数据结构不同，索引也有一些其他的附加作用。

总结下来，索引有如下三个优点：
- 大大减少了服务器需要扫描的数据量。
- 可以帮助服务器避免排序和临时表。
- 可以将随机I/O变成顺序I/O。

**索引是最好的解决方案吗？**

索引并不总是最好的工具。只有当索引帮助存储引擎快速查找到记录带来的好处大于其带来的额外工作时，索引才是有效的。

对于非常小的表，大部分情况下简单的全表扫描更高效。

对于中大型表，索引就非常有效。

对于特大型表，建立和使用索引的代价将随之增长。此时需要一种技术可以直接区分出查询需要的一组数据，而非一条一条记录地匹配。如分区技术。

## 5.3 高性能地索引策略

### 5.3.1 独立的列

如果查询的列不是独立的（索引列是表达式的一部分或函数的参数），则MySQL就不会使用索引。

如下索引就无法使用actor_id列的索引：

```
SELECT actor_id FROM sakila.actor WHERE actor_id + 1 =5;
```

### 5.3.2 前缀索引和索引选择性

索引很长的字符列会让索引变得大且慢，一个策略是模拟哈希索引。另一策略是索引字符的前缀，这样可大大节约索引空间，从而提高索引效率。后者会降低索引的选择性（不重复的索引值和数据表的记录总数）。唯一索引的选择性是1，这是最好的索引选择性，性能也是最好的。

前缀索引是一种能使索引更小、更快的有效方法，但也有其缺点：MySQL无法使用前缀索引做`ORDER BY`和`GROUP BY`。

有时候**后缀索引**（suffix index）也有其用途。MySQL并不原生地支持反向索引，但可以把字符串反转后存储。


对于BLOB、TEXT或很长的VARCHAR类型的列，必须使用前缀索引，因为MySQL不允许索引这些列的完整长度。





